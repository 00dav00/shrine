<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>direct_s3.md</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='file' id='wrapper'>
      <div class='header'>
        <h1 class='name'>direct_s3.md</h1>
        <div class='paths'>
          doc/direct_s3.md
        </div>
        <div class='last-update'>
          Last Update:
          <span class='datetime'>2016-08-27 18:39:30 +0800</span>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            
            <h1 id="label-Direct+Uploads+to+S3">Direct Uploads to S3<span><a href="#label-Direct+Uploads+to+S3">&para;</a> <a href="#top">&uarr;</a></span></h1>
            
            <p><a href="../../classes/Shrine.html">Shrine</a> gives you the ability to
            upload files directly to Amazon S3, which is beneficial for several use
            cases:</p>
            <ul><li>
            <p>accepting uploads is resource-intensive for the server, and delegating it
            to  an external service makes scaling easier</p>
            </li><li>
            <p>if both temporary and permanent storage are S3, promoting an S3 file to 
            permanent storage will simply issue an S3 copy request, without any 
            downloading and reuploading</p>
            </li><li>
            <p>with multiple servers it&#39;s generally not possible to cache files to the
            disk,  unless you&#39;re using a distibuted filesystem that&#39;s shared
            between servers</p>
            </li><li>
            <p>Heroku restricts file uploads to disk, allowing you to save files only in 
            the temporary folder, which gets wiped out between deploys</p>
            </li><li>
            <p>Heroku has a 30-second request limit, so if the client has a slow
            connection  and/or your files are larger, uploads to your app can easily
            hit that limit</p>
            </li></ul>
            
            <p>You can start by setting both temporary and permanent storage to S3 with
            different prefixes (or even buckets):</p>
            
            <pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;aws-sdk&quot;</span>, <span class="ruby-string">&quot;~&gt; 2.1&quot;</span></pre>
            
            <pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;shrine/storage/s3&quot;</span>&#x000A;&#x000A;<span class="ruby-identifier">s3_options</span> = {<span class="ruby-identifier">access_key_id</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;...&quot;</span>, <span class="ruby-identifier">secret_access_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;...&quot;</span>, <span class="ruby-identifier">region</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;...&quot;</span>}&#x000A;&#x000A;<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">storages</span> = {&#x000A;  <span class="ruby-identifier">cache</span><span class="ruby-operator">:</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span><span class="ruby-operator">::</span><span class="ruby-constant">S3</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">prefix</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;cache&quot;</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">s3_options</span>),&#x000A;  <span class="ruby-identifier">store</span><span class="ruby-operator">:</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span><span class="ruby-operator">::</span><span class="ruby-constant">S3</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">prefix</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;store&quot;</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">s3_options</span>),&#x000A;}</pre>
            
            <h2 id="label-Enabling+CORS">Enabling CORS<span><a href="#label-Enabling+CORS">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>In order to be able upload files directly to your S3 bucket, you need
            enable CORS. You can do that in the AWS S3 Console by clicking on
            “Properties &gt; Permissions &gt; Add CORS Configuration”, and then just
            follow the Amazon documentation on how to write a CORS file.</p>
            
            <p><a
            href="http://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html">docs.aws.amazon.com/AmazonS3/latest/dev/cors.html</a></p>
            
            <p>Note that it may take some time for the CORS settings to be applied, due to
            DNS propagation.</p>
            
            <h2 id="label-File+hash">File hash<span><a href="#label-File+hash">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>After direct S3 uploads we&#39;ll need to manually construct Shrine&#39;s
            representation of an uploaded file:</p>
            
            <pre class="ruby">{&#x000A;  <span class="ruby-string">&quot;id&quot;</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;349234854924394&quot;</span>, <span class="ruby-comment"># requied</span>&#x000A;  <span class="ruby-string">&quot;storage&quot;</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;cache&quot;</span>, <span class="ruby-comment"># required</span>&#x000A;  <span class="ruby-string">&quot;metadata&quot;</span><span class="ruby-operator">:</span> {&#x000A;    <span class="ruby-string">&quot;size&quot;</span><span class="ruby-operator">:</span> <span class="ruby-value">45461</span>, <span class="ruby-comment"># optional</span>&#x000A;    <span class="ruby-string">&quot;filename&quot;</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;foo.jpg&quot;</span>, <span class="ruby-comment"># optional</span>&#x000A;    <span class="ruby-string">&quot;mime_type&quot;</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;image/jpeg&quot;</span>, <span class="ruby-comment"># optional</span>&#x000A;  }&#x000A;}</pre>
            <ul><li>
            <p><code>id</code> – location of the file on S3 (minus the
            <code>:prefix</code>)</p>
            </li><li>
            <p><code>storage</code> – direct uploads typically use the <code>:cache</code>
            storage</p>
            </li><li>
            <p><code>metadata</code> – hash of metadata extracted from the file</p>
            </li></ul>
            
            <h2 id="label-Strategy+A+-28dynamic-29">Strategy A (dynamic)<span><a href="#label-Strategy+A+-28dynamic-29">&para;</a> <a href="#top">&uarr;</a></span></h2>
            <ul><li>
            <p>Best user experience</p>
            </li><li>
            <p>Single or multiple file uploads</p>
            </li><li>
            <p>Some JavaScript needed</p>
            </li></ul>
            
            <p>When the user selects the file, we dynamically fetch the presign from the
            server, and use this information to start uploading the file to S3. The
            <code>direct_upload</code> plugin gives us this presign route, so we just
            need to mount it in our application:</p>
            
            <pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;roda&quot;</span></pre>
            
            <pre class="ruby"><span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">direct_upload</span></pre>
            
            <pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>&#x000A;  <span class="ruby-identifier">mount</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">UploadEndpoint</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;/images&quot;</span>&#x000A;<span class="ruby-keyword">end</span></pre>
            
            <p>This gives your application a <code>GET /images/cache/presign</code> route,
            which returns the S3 URL which the file should be uploaded to, along with
            the necessary request parameters:</p>
            
            <pre class="ruby"><span class="ruby-comment"># GET /images/cache/presign</span>&#x000A;{&#x000A;  <span class="ruby-string">&quot;url&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;https://my-bucket.s3-eu-west-1.amazonaws.com&quot;</span>,&#x000A;  <span class="ruby-string">&quot;fields&quot;</span> =<span class="ruby-operator">&gt;</span> {&#x000A;    <span class="ruby-string">&quot;key&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;b7d575850ba61b44c8a9ff889dfdb14d88cdc25f8dd121004c8&quot;</span>,&#x000A;    <span class="ruby-string">&quot;policy&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;eyJleHBpcmF0aW9uIjoiMjAxNS0QwMToxMToyOVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJzaHJpbmUtdGVzdGluZyJ9LHsia2V5IjoiYjdkNTc1ODUwYmE2MWI0NGU3Y2M4YTliZmY4OGU5ZGZkYjE2NTQ0ZDk4OGNkYzI1ZjhkZDEyMTAwNGM4In0seyJ4LWFtei1jcmVkZW50aWFsIjoiQUtJQUlKRjU1VE1aWlk0NVVUNlEvMjAxNTEwMjQvZXUtd2VzdC0xL3MzL2F3czRfcmVxdWVzdCJ9LHsieC1hbXotYWxnb3JpdGhtIjoiQVdTNC1ITUFDLVNIQTI1NiJ9LHsieC1hbXotZGF0ZSI6IjIwMTUxMDI0VDAwMTEyOVoifV19&quot;</span>,&#x000A;    <span class="ruby-string">&quot;x-amz-credential&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;AKIAIJF55TMZYT6Q/20151024/eu-west-1/s3/aws4_request&quot;</span>,&#x000A;    <span class="ruby-string">&quot;x-amz-algorithm&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;AWS4-HMAC-SHA256&quot;</span>,&#x000A;    <span class="ruby-string">&quot;x-amz-date&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;20151024T001129Z&quot;</span>,&#x000A;    <span class="ruby-string">&quot;x-amz-signature&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;c1eb634f83f96b69bd675f535b3ff15ae184b102fcba51e4db5f4959b4ae26f4&quot;</span>&#x000A;  }&#x000A;}</pre>
            
            <p>For uploading to S3 you&#39;ll probably want to use a JavaScript file
            upload library like <a
            href="https://github.com/blueimp/jQuery-File-Upload">jQuery-File-Upload</a>,
            <a href="https://github.com/enyo/dropzone">Dropzone</a> or [FineUploader].
            After the upload you should create a JSON representation of the uploaded
            file, which you can write to the hidden attachment field:</p>
            
            <pre>&lt;input type=&#39;hidden&#39; name=&#39;photo[image]&#39; value=&#39;{&#x000A;  &quot;id&quot;: &quot;302858ldg9agjad7f3ls.jpg&quot;,&#x000A;  &quot;storage&quot;: &quot;cache&quot;,&#x000A;  &quot;metadata&quot;: {&#x000A;    &quot;size&quot;: 943483,&#x000A;    &quot;filename&quot;: &quot;nature.jpg&quot;,&#x000A;    &quot;mime_type&quot;: &quot;image/jpeg&quot;,&#x000A;  }&#x000A;}&#39;&gt;</pre>
            
            <p>See the <a href="https://github.com/janko-m/shrine/tree/master/demo">demo
            app</a> for an example JavaScript implementation of multiple direct S3
            uploads.</p>
            
            <h2 id="label-Strategy+B+-28static-29">Strategy B (static)<span><a href="#label-Strategy+B+-28static-29">&para;</a> <a href="#top">&uarr;</a></span></h2>
            <ul><li>
            <p>Basic user experience</p>
            </li><li>
            <p>Only for single uploads</p>
            </li><li>
            <p>No JavaScript needed</p>
            </li></ul>
            
            <p>An alternative to the previous strategy is generating a file upload form
            immediately when the page is rendered, and then file upload can be either
            asynchronous, or synchronous with redirection. For generating the form we
            can use <code>Shrine::Storage::S3#presign</code>, which returns a <a
            href="http://docs.aws.amazon.com/sdkforruby/api/Aws/S3/Bucket.html#presigned_post-instance_method">Aws::S3::PresignedPost</a>
            object, which has <code>#url</code> and <code>#fields</code> methods:</p>
            
            <pre>&lt;% presign = Shrine.storages[:cache].presign(SecureRandom.hex, success_action_redirect: new_album_url) %&gt;&#x000A;&lt;form action=&quot;&lt;%= presign.url %&gt;&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;&#x000A;  &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&#x000A;  &lt;% presign.fields.each do |name, value| %&gt;&#x000A;    &lt;input type=&quot;hidden&quot; name=&quot;&lt;%= name %&gt;&quot; value=&quot;&lt;%= value %&gt;&quot;&gt;&#x000A;  &lt;% end %&gt;&#x000A;  &lt;input type=&quot;submit&quot; value=&quot;Upload&quot;&gt;&#x000A;&lt;/form&gt;</pre>
            
            <p>If you&#39;re doing synchronous upload with redirection, the redirect URL
            will include the object key in the query parameters, which you can use to
            generate Shrine&#39;s uploaded file representation:</p>
            
            <pre>&lt;%&#x000A;  cached_file = {&#x000A;    storage: &quot;cache&quot;,&#x000A;    id: params[:key][/cache\/(.+)/, 1], # we have to remove the prefix part&#x000A;    metadata: {},&#x000A;  }&#x000A;%&gt;&#x000A;&lt;form action=&quot;/albums&quot; method=&quot;post&quot;&gt;&#x000A;  &lt;input type=&quot;hidden&quot; name=&quot;album[image]&quot; value=&quot;&lt;%= cached_file.to_json %&gt;&quot;&gt;&#x000A;  &lt;input type=&quot;submit&quot; value=&quot;Save&quot;&gt;&#x000A;&lt;/form&gt;</pre>
            
            <h2 id="label-Metadata">Metadata<span><a href="#label-Metadata">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>With direct uploads any metadata has to be extracted on the client, since
            caching the file doesn&#39;t touch your application. When the cached file
            is stored, Shrine&#39;s default behaviour is to simply copy over cached
            file&#39;s metadata.</p>
            
            <p>If you want to extract metadata on the server before storing, you can just
            load the <code>restore_cached_data</code> plugin.</p>
            
            <pre class="ruby"><span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">restore_cached_data</span></pre>
            
            <h2 id="label-Clearing+cache">Clearing cache<span><a href="#label-Clearing+cache">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>Since directly uploaded files will stay in your temporary storage, you will
            want to periodically delete the old ones that were already promoted.
            Luckily, Amazon provides <a
            href="http://docs.aws.amazon.com/AmazonS3/latest/UG/lifecycle-configuration-bucket-no-versioning.html">a
            built-in solution</a> for that.</p>
            
            <h2 id="label-Eventual+consistency">Eventual consistency<span><a href="#label-Eventual+consistency">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>When uploading objects to Amazon S3, sometimes they may not be available
            immediately. This can be a problem when using direct S3 uploads, because
            usually in this case you&#39;re using S3 for both cache and store, so the
            S3 object is moved to store soon after caching.</p>
            
            <blockquote>
            <p>Amazon S3 provides eventual consistency for some operations, so it is
            possible that new data will not be available immediately after the upload,
            which could result in an incomplete data load or loading stale data. COPY
            operations where the cluster and the bucket are in different regions are
            eventually consistent. All regions provide read-after-write consistency for
            uploads of new objects with unique object keys. For more information about
            data consistency, see <a
            href="http://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyMode">Amazon
            S3 Data Consistency Model</a> in the <em>Amazon Simple Storage Service
            Developer Guide</em>.</p>
            </blockquote>
            
            <p>This means that in certain cases copying from cache to store can fail if it
            happens immediately after uploading to cache. If you start noticing these
            errors, and you&#39;re using <code>backgrounding</code> plugin, you can
            tell your backgrounding library to perform the job with a delay:</p>
            
            <pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">backgrounding</span>&#x000A;&#x000A;<span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">promote</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-constant">PromoteJob</span>.<span class="ruby-identifier">perform_in</span>(<span class="ruby-value">3</span>, <span class="ruby-identifier">data</span>) <span class="ruby-comment"># tells a Sidekiq worker to perform in 3 seconds</span>&#x000A;<span class="ruby-keyword">end</span></pre>
          </div>
          <div id='context'>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a target="docwin" href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
