<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>multiple_files.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>multiple_files.md
</h1>
<div class='paths'>
doc/multiple_files.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2017-09-11 12:36:08 +0200</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<h1 id="label-Multiple+Files">Multiple Files<span><a href="#label-Multiple+Files">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>There are often times when you want to allow users to attach multiple files
to a single resource. Some file attachment libraries provide a special
interface for multiple attachments, but <a
href="../../classes/Shrine.html">Shrine</a> doesn&#39;t come with one,
because it&#39;s much more robust and flexible to implement this using your
ORM directly.</p>

<p>The idea is to create a new table, and attach each uploaded file to a
separate record on that table, while having a “many-to-one” relationship
with the main table. That way a database record from the main table can
implicitly have multiple attachments through the associated records.</p>

<pre class="ruby"><span class="ruby-identifier">album</span>&#x000A;  <span class="ruby-identifier">photo1</span>&#x000A;    <span class="ruby-operator">-</span> <span class="ruby-identifier">attachment1</span>&#x000A;  <span class="ruby-identifier">photo2</span>&#x000A;    <span class="ruby-operator">-</span> <span class="ruby-identifier">attachment2</span>&#x000A;  <span class="ruby-identifier">photo3</span>&#x000A;    <span class="ruby-operator">-</span> <span class="ruby-identifier">attachment3</span></pre>

<p>This design gives you great flexibility, allowing you to support:</p>
<ul><li>
<p>adding new attachments</p>
</li><li>
<p>updating existing attachments</p>
</li><li>
<p>removing existing attachments</p>
</li><li>
<p>sorting attachments</p>
</li><li>
<p>having additional fields on attachments (captions, votes, number of
downloads etc.)</p>
</li><li>
<p>…</p>
</li></ul>

<p>If you&#39;re using Sequel or ActiveRecord, the easiest way to implement
this is via nested attributes, which you would in general use for any
dynamic “one-to-many” association. The examples will be using Sequel, but
with ActiveRecord it&#39;s very similar, here are the docs:</p>
<ul><li>
<p><a
href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/NestedAttributes.html">Sequel::Model.nested_attributes</a></p>
</li><li>
<p><a
href="http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html">ActiveRecord::Base.accepts_nested_attributes_for</a></p>
</li></ul>

<p>For simplicity, for the rest of this guide we will assume that we have
“albums” that can have multiple “photos”.</p>

<h2 id="label-1.+Attachments+table">1. Attachments table<span><a href="#label-1.+Attachments+table">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Let&#39;s create a table for our attachments, and add a foreign key for the
main table:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">migration</span> <span class="ruby-keyword">do</span>&#x000A;  <span class="ruby-identifier">change</span> <span class="ruby-keyword">do</span>&#x000A;    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">photos</span> <span class="ruby-keyword">do</span>&#x000A;      <span class="ruby-identifier">primary_key</span> :<span class="ruby-identifier">id</span>&#x000A;      <span class="ruby-identifier">foreign_key</span> :<span class="ruby-identifier">album_id</span>, :<span class="ruby-identifier">albums</span>&#x000A;      <span class="ruby-identifier">column</span>      :<span class="ruby-identifier">image_data</span>, :<span class="ruby-identifier">text</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<p>In our new model we can create a <a
href="../../classes/Shrine.html">Shrine</a> attachment attribute:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>&#x000A;  <span class="ruby-identifier">include</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-identifier">image</span>)&#x000A;<span class="ruby-keyword">end</span></pre>

<h2 id="label-2.+Nested+attributes">2. Nested attributes<span><a href="#label-2.+Nested+attributes">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In our main model we can now declare the association to the new table, and
allow it to directly accept attributes for the associated records:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>&#x000A;  <span class="ruby-identifier">one_to_many</span> :<span class="ruby-identifier">photos</span>&#x000A;&#x000A;  <span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">nested_attributes</span> <span class="ruby-comment"># load the plugin</span>&#x000A;  <span class="ruby-identifier">nested_attributes</span> :<span class="ruby-identifier">photos</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<h2 id="label-3.+View">3. View<span><a href="#label-3.+View">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In order to allow the user to select multiple files in the form, we just
need to add the <code>multiple</code> attribute to the file field.</p>

<pre>&lt;input type=&quot;file&quot; multiple name=&quot;file&quot;&gt;</pre>

<p>You can then use a generic JavaScript file upload library like <a
href="https://github.com/blueimp/jQuery-File-Upload">jQuery-File-Upload</a>,
<a href="https://github.com/enyo/dropzone">Dropzone</a> or <a
href="https://github.com/FineUploader/fine-uploader">FineUploader</a> to
asynchronously upload each of the selected files to your app or to an
external service. See the <code>upload_endpoint</code> and
<code>presign_endpoint</code> plugins, and <a
href="http://shrinerb.com/rdoc/files/doc/direct_s3_md.html">Direct Uploads
to S3</a> guide for more details.</p>

<p>After each upload finishes, you can generate a nested hash for the new
associated record, and write the uploaded file JSON to the attachment
field:</p>

<pre class="ruby"><span class="ruby-identifier">album</span>[<span class="ruby-identifier">photos_attributes</span>][<span class="ruby-value">0</span>][<span class="ruby-identifier">image</span>] = <span class="ruby-string">&#39;{&quot;id&quot;:&quot;38k25.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;</span>&#x000A;<span class="ruby-identifier">album</span>[<span class="ruby-identifier">photos_attributes</span>][<span class="ruby-value">1</span>][<span class="ruby-identifier">image</span>] = <span class="ruby-string">&#39;{&quot;id&quot;:&quot;sg0fg.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;</span>&#x000A;<span class="ruby-identifier">album</span>[<span class="ruby-identifier">photos_attributes</span>][<span class="ruby-value">2</span>][<span class="ruby-identifier">image</span>] = <span class="ruby-string">&#39;{&quot;id&quot;:&quot;041jd.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;</span></pre>

<p>Once you submit this to the app, the ORM&#39;s nested attributes behaviour
will create the associated records, and assign the <a
href="../../classes/Shrine.html">Shrine</a> attachments.</p>

<p>Now you can manage adding new, or updating and deleting existing
attachments, just by using your ORM&#39;s nested attributes behaviour, the
same way that you would do with any other dynamic one-to-many association.
The callbacks that are added by including the <a
href="../../classes/Shrine.html">Shrine</a> module to the associated model
will automatically take care of the attachment management.</p>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/rdoc/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
