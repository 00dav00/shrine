<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>multiple_files.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>multiple_files.md
</h1>
<div class='paths'>
doc/multiple_files.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2018-08-22 01:27:24 +0200</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<h1 id="label-Multiple+Files">Multiple Files<span><a href="#label-Multiple+Files">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>There are times when you want to allow users to attach multiple files to a
single resource, like an album having many photos or a playlist having many
songs. Some file attachment libraries provide a special interface for
multiple attachments, but <a href="../../classes/Shrine.html">Shrine</a>
doesn&#39;t have one, because it&#39;s more flexible to use the “nested
attributes” feature of your ORM directly to implement this.</p>

<p>The basic idea is to create a separate table that will have a many-to-one
relationship with the main table, and files will be attached on the records
in the new table. That way each record from the main table can implicitly
have multiple attachments through the associated records.</p>

<pre>album1&#x000A;  photo1&#x000A;    - attachment1&#x000A;  photo2&#x000A;    - attachment2&#x000A;  photo3&#x000A;    - attachment3&#x000A;album2&#x000A;  photo4&#x000A;    - attachment4&#x000A;  photo5&#x000A;    - attachment5&#x000A;&#x000A;...</pre>

<p>To illustrate, this code will create an album with three photos using
nested attributes:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">create</span>(&#x000A;  <span class="ruby-value">title:</span> <span class="ruby-string">&quot;My Album&quot;</span>,&#x000A;  <span class="ruby-value">photos_attributes:</span> [&#x000A;    { <span class="ruby-value">image:</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;image1.jpg&quot;</span>, <span class="ruby-string">&quot;rb&quot;</span>) },&#x000A;    { <span class="ruby-value">image:</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;image2.jpg&quot;</span>, <span class="ruby-string">&quot;rb&quot;</span>) },&#x000A;    { <span class="ruby-value">image:</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;image3.jpg&quot;</span>, <span class="ruby-string">&quot;rb&quot;</span>) },&#x000A;  ]&#x000A;)</pre>

<p>This design gives you the greatest flexibility, allowing you to support:</p>
<ul><li>
<p>adding new attachments</p>
</li><li>
<p>updating existing attachments</p>
</li><li>
<p>removing existing attachments</p>
</li><li>
<p>sorting attachments (via a separate position column)</p>
</li><li>
<p>having additional fields on attachments (e.g. captions, votes, number of
downloads etc.)</p>
</li><li>
<p>expanding this to be “many-to-many” relation (e.g. create different
playlists from a list of songs, etc)</p>
</li><li>
<p>…</p>
</li></ul>

<h2 id="label-How+to+Implement">How to Implement<span><a href="#label-How+to+Implement">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>For the rest of this guide, we will use the example where we have “albums”
that can have multiple “photos” in it. The main table is the albums table
and the files (or attachments) table will be the photos table.</p>

<h3 id="label-1.+Create+the+main+resource+and+attachment+table">1. Create the main resource and attachment table<span><a href="#label-1.+Create+the+main+resource+and+attachment+table">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Let&#39;s create a table for the main resource and attachments, and add a
foreign key in the attachment table for the main table:</p>

<pre class="ruby"><span class="ruby-comment"># Sequel</span>&#x000A;<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">migration</span> <span class="ruby-keyword">do</span>&#x000A;  <span class="ruby-identifier">change</span> <span class="ruby-keyword">do</span>&#x000A;    <span class="ruby-identifier">create_table</span> <span class="ruby-value">:albums</span> <span class="ruby-keyword">do</span>&#x000A;      <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>&#x000A;      <span class="ruby-identifier">column</span>      <span class="ruby-value">:title</span>, <span class="ruby-value">:text</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;&#x000A;    <span class="ruby-identifier">create_table</span> <span class="ruby-value">:photos</span> <span class="ruby-keyword">do</span>&#x000A;      <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>&#x000A;      <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:album_id</span>, <span class="ruby-value">:albums</span>&#x000A;      <span class="ruby-identifier">column</span>      <span class="ruby-value">:image_data</span>, <span class="ruby-value">:text</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-comment"># Active Record</span>&#x000A;<span class="ruby-keyword">class</span> <span class="ruby-constant">CreateAlbumsAndPhotos</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>&#x000A;  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">change</span>&#x000A;    <span class="ruby-identifier">create_table</span> <span class="ruby-value">:albums</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>&#x000A;      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span>     <span class="ruby-value">:title</span>&#x000A;      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;&#x000A;    <span class="ruby-identifier">create_table</span> <span class="ruby-value">:photos</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>&#x000A;      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">references</span> <span class="ruby-value">:album</span>, <span class="ruby-value">foreign_key:</span> <span class="ruby-keyword">true</span>&#x000A;      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">text</span>       <span class="ruby-value">:image_data</span>&#x000A;      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<p>In the Photo model, create a <a href="../../classes/Shrine.html">Shrine</a>
attachment attribute named <code>image</code> (<code>:image</code> matches
the <code>_data</code> column prefix above):</p>

<pre class="ruby"><span class="ruby-comment"># Sequel</span>&#x000A;<span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>&#x000A;  <span class="ruby-identifier">include</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:image</span>)&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-comment"># Active Record</span>&#x000A;<span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>&#x000A;  <span class="ruby-identifier">include</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:image</span>)&#x000A;<span class="ruby-keyword">end</span></pre>

<h3 id="label-2.+Declare+nested+attributes">2. Declare nested attributes<span><a href="#label-2.+Declare+nested+attributes">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Using nested attributes is the easiest way to implement any dynamic
“one-to-many” association. In the Album model we&#39;ll declare a
one-to-many relationship to the photos table, and allow it to directly
accept attributes for the associated photo records by enabling nested
attributes:</p>

<pre class="ruby"><span class="ruby-comment"># Sequel</span>&#x000A;<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>&#x000A;  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:photos</span>&#x000A;  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:association_dependencies</span>, <span class="ruby-value">photos:</span> <span class="ruby-value">:destroy</span> <span class="ruby-comment"># destroy photos when album is destroyed</span>&#x000A;&#x000A;  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:nested_attributes</span>&#x000A;  <span class="ruby-identifier">nested_attributes</span> <span class="ruby-value">:photos</span>, <span class="ruby-value">destroy:</span> <span class="ruby-keyword">true</span>&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-comment"># Active Record</span>&#x000A;<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>&#x000A;  <span class="ruby-identifier">has_many</span> <span class="ruby-value">:photos</span>, <span class="ruby-value">dependent:</span> <span class="ruby-value">:destroy</span>&#x000A;  <span class="ruby-identifier">accepts_nested_attributes_for</span> <span class="ruby-value">:photos</span>, <span class="ruby-value">allow_destroy:</span> <span class="ruby-keyword">true</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<p>Documentation on nested attributes:</p>
<ul><li>
<p><a
href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/NestedAttributes.html">Sequel::Model.nested_attributes</a></p>
</li><li>
<p><a
href="http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html">ActiveRecord::Base.accepts_nested_attributes_for</a></p>
</li></ul>

<h3 id="label-3.+Create+the+View">3. Create the View<span><a href="#label-3.+Create+the+View">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Create a form like you normally do to create the album. To this form
we&#39;ll add a file field for selecting photos, which will have
<code>multiple</code> attribute to allow the user to select multiple files.
We&#39;ll also display nested fields for already created photos, so that
the same form can be used for updating the album/photos as well (they will
be submitted under the <code>album[photos_attributes]</code> parameter).</p>

<pre class="ruby"><span class="ruby-comment"># with Forme:</span>&#x000A;<span class="ruby-identifier">form</span> <span class="ruby-ivar">@album</span>, <span class="ruby-value">action:</span> <span class="ruby-string">&quot;/photos&quot;</span>, <span class="ruby-value">enctype:</span> <span class="ruby-string">&quot;multipart/form-data&quot;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">input</span> <span class="ruby-value">:title</span>&#x000A;  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">subform</span> <span class="ruby-value">:photos</span> <span class="ruby-keyword">do</span> <span class="ruby-comment"># adds new `album[photos_attributes]` parameter</span>&#x000A;    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">input</span> <span class="ruby-value">:image</span>,   <span class="ruby-value">type:</span> <span class="ruby-value">:hidden</span>, <span class="ruby-value">value:</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">cached_image_data</span>&#x000A;    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">input</span> <span class="ruby-value">:image</span>,   <span class="ruby-value">type:</span> <span class="ruby-value">:file</span>&#x000A;    <span class="ruby-identifier">f</span>.<span class="ruby-identifier">input</span> <span class="ruby-value">:_delete</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:checkbox</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">new?</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">input</span> <span class="ruby-string">&quot;files[]&quot;</span>, <span class="ruby-value">type:</span> <span class="ruby-value">:file</span>, <span class="ruby-value">attr:</span> { <span class="ruby-value">multiple:</span> <span class="ruby-keyword">true</span> }, <span class="ruby-value">obj:</span> <span class="ruby-keyword">nil</span>&#x000A;  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">button</span> <span class="ruby-string">&quot;Create&quot;</span>&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-comment"># with Rails form builder:</span>&#x000A;<span class="ruby-identifier">form_for</span> <span class="ruby-ivar">@album</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">text_field</span> <span class="ruby-value">:title</span>&#x000A;  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">fields_for</span> <span class="ruby-value">:photos</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-comment"># adds new `album[photos_attributes]` parameter</span>&#x000A;    <span class="ruby-identifier">p</span>.<span class="ruby-identifier">hidden_field</span> <span class="ruby-value">:image</span>, <span class="ruby-value">value:</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">object</span>.<span class="ruby-identifier">cached_image_data</span>&#x000A;    <span class="ruby-identifier">p</span>.<span class="ruby-identifier">file_field</span>   <span class="ruby-value">:image</span>&#x000A;    <span class="ruby-identifier">p</span>.<span class="ruby-identifier">check_box</span>    <span class="ruby-value">:_destroy</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">object</span>.<span class="ruby-identifier">new_record?</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-identifier">file_field_tag</span> <span class="ruby-string">&quot;files[]&quot;</span>, <span class="ruby-value">multiple:</span> <span class="ruby-keyword">true</span>&#x000A;  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">submit</span> <span class="ruby-string">&quot;Create&quot;</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<p>In your controller you should still be able to assign all the attributes to
the album, just remember to whitelist the new parameter for the nested
attributes, in this case <code>photos_attributes</code>.</p>

<h3 id="label-4.+Direct+Upload">4. Direct Upload<span><a href="#label-4.+Direct+Upload">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>On the client side, you can asynchronously upload each of the files to a
direct upload endpoint as soon as they&#39;re selected. There are two
methods of implementing direct uploads: upload to your app using the <a
href="https://shrinerb.com/rdoc/classes/Shrine/Plugins/UploadEndpoint.html">upload_endpoint</a>
plugin or upload to directly to storage like S3 using the <a
href="https://shrinerb.com/rdoc/classes/Shrine/Plugins/PresignEndpoint.html">presign_endpoint</a>
plugin. It&#39;s recommended to use <a href="https://uppy.io">Uppy</a> to
handle the uploads on the client side.</p>

<p>Once files are uploaded asynchronously, you can dynamically insert photo
attachment fields for the <code>image</code> attribute to the form filled
with uploaded file data, so that the corresponding photo records are
automatically created after form submission. The hidden attachment fields
should contain uploaded file data in JSON format, just like when doing
single direct uploads. The attachment field names should be namespaced
according to the convention that the nested attributes feature expects. In
this case it should be <code>album[photos_attributes][&lt;idx&gt;]</code>,
where <code>&lt;idx&gt;</code> is any incrementing integer (e.g. you can
use the current UNIX timestamp).</p>

<pre class="ruby"><span class="ruby-comment"># naming format in which photos fields should be generated and submitted</span>&#x000A;<span class="ruby-identifier">album</span>[<span class="ruby-identifier">photos_attributes</span>][<span class="ruby-value">11111</span>][<span class="ruby-identifier">image</span>] = <span class="ruby-string">&#39;{&quot;id&quot;:&quot;38k25.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;</span>&#x000A;<span class="ruby-identifier">album</span>[<span class="ruby-identifier">photos_attributes</span>][<span class="ruby-value">29323</span>][<span class="ruby-identifier">image</span>] = <span class="ruby-string">&#39;{&quot;id&quot;:&quot;sg0fg.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;</span>&#x000A;<span class="ruby-identifier">album</span>[<span class="ruby-identifier">photos_attributes</span>][<span class="ruby-value">34820</span>][<span class="ruby-identifier">image</span>] = <span class="ruby-string">&#39;{&quot;id&quot;:&quot;041jd.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;</span>&#x000A;<span class="ruby-comment"># ...</span></pre>

<p>See the walkthroughs for setting up simple <a
href="https://github.com/shrinerb/shrine/wiki/Adding-Direct-App-Uploads">direct
app uploads</a> and <a
href="https://github.com/shrinerb/shrine/wiki/Adding-Direct-S3-Uploads">direct
S3 uploads</a>, and the <a
href="https://github.com/shrinerb/shrine/tree/master/demo">Roda</a> or <a
href="https://github.com/erikdahlstrand/shrine-rails-example">Rails</a>
demo app which implements multiple file uploads.</p>

<h3 id="label-5.+Adding+Validations">5. Adding Validations<span><a href="#label-5.+Adding+Validations">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can add file validations to the <code>Photo</code> model using the
<code>validation_helpers</code> plugin. You just need to make sure that
your ORM is configured to automatically validate associated records.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>&#x000A;  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:validation_helpers</span>&#x000A;  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:determine_mime_type</span>&#x000A;&#x000A;  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">validate</span> <span class="ruby-keyword">do</span>&#x000A;    <span class="ruby-identifier">validate_max_size</span> <span class="ruby-value">10</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span>&#x000A;    <span class="ruby-identifier">validate_mime_type_inclusion</span> <span class="ruby-node">%w[image/jpeg image/png]</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<pre class="ruby"><span class="ruby-comment"># Sequel</span>&#x000A;<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>&#x000A;  <span class="ruby-comment"># ... (nested_attributes already enables validating associated photos) ...</span>&#x000A;<span class="ruby-keyword">end</span>&#x000A;&#x000A;<span class="ruby-comment"># ActiveRecord</span>&#x000A;<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>&#x000A;  <span class="ruby-comment"># ...</span>&#x000A;  <span class="ruby-identifier">validates_associated</span> <span class="ruby-value">:photos</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<h3 id="label-6.+Conclusion">6. Conclusion<span><a href="#label-6.+Conclusion">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Now we have a simple interface for accepting multiple attachments, which
internally uses nested attributes to create multiple associated records,
each with a single attachment. After creation you can also add new
attachments, or update and delete existing ones, which the nested
attributes feature gives you for free.</p>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/rdoc/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
