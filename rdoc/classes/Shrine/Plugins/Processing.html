<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>Shrine::Plugins::Processing</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>module</span>
Shrine::Plugins::Processing
</h1>
<ol class='paths'>
<li>
<a href="https://github.com/janko-m/shrine/blob/1c585bf7d06ed8550281544b0d6fca57f397eeed/lib/shrine/plugins/processing.rb">lib/shrine/plugins/processing.rb</a> <img src="/images/github.png" width=13 height=12 style="position:absolute; margin-left:5px;">
</li>
</ol>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p><a href="../../Shrine.html">Shrine</a> uploaders can define the
<code>#process</code> method, which will get called whenever a file is
uploaded. It is given the original file, and is expected to return the
processed files.</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">io</span>, <span class="ruby-identifier">context</span>)&#x000A;  <span class="ruby-comment"># you can process the original file `io` and return processed file(s)</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<p>However, when handling files as attachments, the same file is uploaded to
temporary and permanent storage. Since we only want to apply the same
processing once, we need to branch based on the context.</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">io</span>, <span class="ruby-identifier">context</span>)&#x000A;  <span class="ruby-keyword">if</span> <span class="ruby-identifier">context</span>[:<span class="ruby-identifier">action</span>] <span class="ruby-operator">==</span> :<span class="ruby-identifier">store</span> <span class="ruby-comment"># promote phase</span>&#x000A;    <span class="ruby-comment"># ...</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<p>The <code>processing</code> plugin simplifies this by allowing us to
declaratively define file processing for specified actions.</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">processing</span>&#x000A;&#x000A;<span class="ruby-identifier">process</span>(:<span class="ruby-identifier">store</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span>, <span class="ruby-identifier">context</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-comment"># ...</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<p>An example of resizing an image using the <a
href="https://github.com/janko-m/image_processing">image_processing</a>
library:</p>

<pre class="ruby"><span class="ruby-identifier">include</span> <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>&#x000A;&#x000A;<span class="ruby-identifier">process</span>(:<span class="ruby-identifier">store</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span>, <span class="ruby-identifier">context</span><span class="ruby-operator">|</span>&#x000A;  <span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-identifier">io</span>.<span class="ruby-identifier">download</span>, <span class="ruby-value">800</span>, <span class="ruby-value">800</span>)&#x000A;<span class="ruby-keyword">end</span></pre>

<p>The declarations are additive and inheritable, so for the same action you
can declare multiple blocks, and they will be performed in the same order,
with output from previous block being the input to next.</p>

<p>You can manually trigger the defined processing via the uploader, you just
need to specify <code>:action</code> to the name of your processing block:</p>

<pre class="ruby"><span class="ruby-identifier">uploader</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">store</span>)  <span class="ruby-comment"># process and upload</span>&#x000A;<span class="ruby-identifier">uploader</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">store</span>) <span class="ruby-comment"># only process</span></pre>

<p>If you want the result of processing to be multiple files, use the
<code>versions</code> plugin.</p>
</div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Class</h3>
<ol>
<li><a href="#method-c-configure">configure</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='class-list'>
<h2>Classes and Modules</h2>
<ol>
<li><a href="Processing/ClassMethods.html">Shrine::Plugins::Processing::ClassMethods</a></li>
<li><a href="Processing/InstanceMethods.html">Shrine::Plugins::Processing::InstanceMethods</a></li>
</ol>
</div>
<div id='section'>
<div id='methods'>
<h2>Public Class methods</h2>
<div class='method public-class' id='method-method-c-configure'>
<a name='method-c-configure'></a>
<div class='synopsis'>
<span class='name'>configure</span>
<span class='arguments'>(uploader)</span>

</div>
<div class='description'>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-c-configure-source&#39;); return false'>
[show source]
</a>
<pre id='method-c-configure-source'><span class="ruby-comment"># File lib/shrine/plugins/processing.rb, line 53</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">configure</span>(<span class="ruby-identifier">uploader</span>)&#x000A;  <span class="ruby-identifier">uploader</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:processing</span>] = {}&#x000A;<span class="ruby-keyword">end</span></pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/rdoc/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
