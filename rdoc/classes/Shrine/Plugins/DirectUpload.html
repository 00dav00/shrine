<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>Shrine::Plugins::DirectUpload</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>module</span>
          Shrine::Plugins::DirectUpload
        </h1>
        <ol class='paths'>
          <li>
            <a target="docwin" href="../../../files/lib/shrine/plugins/direct_upload_rb.html">lib/shrine/plugins/direct_upload.rb</a>
          </li>
        </ol>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            
            <p>The direct_upload plugin provides a Rack endpoint (implemented in <a
            href="https://github.com/jeremyevans/roda">Roda</a>) which you can use to
            implement AJAX uploads.</p>
            
            <pre class="ruby"><span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">direct_upload</span>, <span class="ruby-identifier">max_size</span><span class="ruby-operator">:</span> <span class="ruby-value">20</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span></pre>
            
            <p>This is how you could mount the endpoint in a Rails application:</p>
            
            <pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>&#x000A;  <span class="ruby-comment"># adds `POST /attachments/images/:storage/:name`</span>&#x000A;  <span class="ruby-identifier">mount</span> <span class="ruby-constant">ImageUploader</span>.<span class="ruby-identifier">direct_endpoint</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;/attachments/images&quot;</span>&#x000A;<span class="ruby-keyword">end</span></pre>
            
            <p>Note that you should mount a separate endpoint for each uploader that you
            want to use it with. This now gives your Ruby application a <code>POST&#x000A;/attachments/images/:storage/:name</code> route, which accepts a “file”
            query parameter:</p>
            
            <pre>$ curl -F &quot;file=@/path/to/avatar.jpg&quot; localhost:3000/attachments/images/cache/avatar&#x000A;# {&quot;id&quot;:&quot;43kewit94.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}</pre>
            
            <p>The endpoint returns all responses in JSON format. There are many great
            JavaScript libraries for AJAX file uploads, so for example if we have this
            form:</p>
            
            <pre>&lt;%= form_for @user do |f| %&gt;&#x000A;  &lt;%= f.hidden_field :avatar, value: @user.avatar_data %&gt;&#x000A;  &lt;%= f.file_field :avatar %&gt;&#x000A;&lt;% end %&gt;</pre>
            
            <p>this is how we could hook up <a
            href="https://github.com/blueimp/jQuery-File-Upload">jQuery-File-Upload</a>
            to our direct upload endpoint:</p>
            
            <pre>$(&#39;[type=&quot;file&quot;]&#39;).fileupload({&#x000A;  url: &#39;/attachments/images/cache/avatar&#39;,&#x000A;  paramName: &#39;file&#39;,&#x000A;  done: function(e, data) { $(this).prev().value(data.result) }&#x000A;});</pre>
            
            <p>Now whenever a file gets chosen, the upload will automatically start in the
            background. It&#39;s typically good to show a progress bar to the user,
            which jQuery-File-Upload <a
            href="https://github.com/blueimp/jQuery-File-Upload/wiki/Options#progress">supports</a>.
            After the upload has finished, the uploaded file JSON is written to the
            hidden field, and will be sent on form submit.</p>
            
            <h2 id="module-Shrine::Plugins::DirectUpload-label-Presigned">Presigned<span><a href="#module-Shrine::Plugins::DirectUpload-label-Presigned">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>An alternative to the direct endpoint is doing direct uploads to the
            underlying storage. These uploads usually requires extra information from
            the server, and this plugin can provide an endpoint to it, which you can
            enable by passing in <code>presign: true</code>:</p>
            
            <pre class="ruby"><span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">direct_upload</span>, <span class="ruby-identifier">presign</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span></pre>
            
            <p>This will disable the default <code>POST /:storage/:name</code> route (for
            security reasons), and enable <code>GET /:storage/presign</code>. The
            response for that request looks something like this:</p>
            
            <pre class="ruby">{&#x000A;  <span class="ruby-string">&quot;url&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;https://shrine-testing.s3-eu-west-1.amazonaws.com&quot;</span>,&#x000A;  <span class="ruby-string">&quot;fields&quot;</span> =<span class="ruby-operator">&gt;</span> {&#x000A;    <span class="ruby-string">&quot;key&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;b7d575850ba61b44c8a9ff889dfdb14d88cdc25f8dd121004c8&quot;</span>,&#x000A;    <span class="ruby-string">&quot;policy&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;eyJleHBpcmF0aW9uIjoiMjAxNS0QwMToxMToyOVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJzaHJpbmUtdGVzdGluZyJ9LHsia2V5IjoiYjdkNTc1ODUwYmE2MWI0NGU3Y2M4YTliZmY4OGU5ZGZkYjE2NTQ0ZDk4OGNkYzI1ZjhkZDEyMTAwNGM4In0seyJ4LWFtei1jcmVkZW50aWFsIjoiQUtJQUlKRjU1VE1aWlk0NVVUNlEvMjAxNTEwMjQvZXUtd2VzdC0xL3MzL2F3czRfcmVxdWVzdCJ9LHsieC1hbXotYWxnb3JpdGhtIjoiQVdTNC1ITUFDLVNIQTI1NiJ9LHsieC1hbXotZGF0ZSI6IjIwMTUxMDI0VDAwMTEyOVoifV19&quot;</span>,&#x000A;    <span class="ruby-string">&quot;x-amz-credential&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;AKIAIJF55TMZYT6Q/20151024/eu-west-1/s3/aws4_request&quot;</span>,&#x000A;    <span class="ruby-string">&quot;x-amz-algorithm&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;AWS4-HMAC-SHA256&quot;</span>,&#x000A;    <span class="ruby-string">&quot;x-amz-date&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;20151024T001129Z&quot;</span>,&#x000A;    <span class="ruby-string">&quot;x-amz-signature&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;c1eb634f83f96b69bd675f535b3ff15ae184b102fcba51e4db5f4959b4ae26f4&quot;</span>&#x000A;  }&#x000A;}</pre>
            
            <p>The <code>url</code> is where the file needs to be uploaded to, and
            <code>fields</code> is additional data that needs to be send on the upload.
            The <code>fields.key</code> attribute is the location where the file will
            be uploaded to, it is generated randomly. <code>GET&#x000A;/:storage/presign</code> accepts additional parameters:</p>
            <table class="rdoc-list note-list"><tbody><tr><td class='label'>:extension</td><td>
            <p>The extension of the file being uploaded (e.g “.jpg”).</p>
            </td></tr><tr><td class='label'>:content_type</td><td>
            <p>Sets the Content-Type header for the uploaded file on S3.</p>
            </td></tr></tbody></table>
            
            <p>Example:</p>
            
            <pre>GET /cache/presign?content_type=image/jpeg&#x000A;GET /cache/presign?extension=.png</pre>
            
            <h2 id="module-Shrine::Plugins::DirectUpload-label-Constraints">Constraints<span><a href="#module-Shrine::Plugins::DirectUpload-label-Constraints">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>Note that the direct upload doesn&#39;t run validations, they are only run
            when attached to the record. If you want to limit the MIME type of files,
            you could add an <a
            href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#attr-accept">“accept”
            attribute</a> to your file field. You could also add client side
            validations for the maximum file size.</p>
            
            <p>It&#39;s encouraged that you set the <code>:max_size</code> option for the
            endpoint. Once set, when a file that is too big is uploaded, the endpoint
            will automatically delete the file and return a 413 response. However, if
            for whatever reason you don&#39;t want to impose a limit on filesize, you
            can set the option to nil:</p>
            
            <pre class="ruby"><span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">direct_upload</span>, <span class="ruby-identifier">max_size</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span></pre>
            
            <h2 id="module-Shrine::Plugins::DirectUpload-label-Allowed+storages">Allowed storages<span><a href="#module-Shrine::Plugins::DirectUpload-label-Allowed+storages">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>While <a href="../../Shrine.html">Shrine</a> only accepts cached
            attachments on form submits (for security reasons), you can use this
            endpoint to upload files to any storage, just add it do allowed storages:</p>
            
            <pre class="ruby"><span class="ruby-identifier">plugin</span> :<span class="ruby-identifier">direct_upload</span>, <span class="ruby-identifier">allowed_storages</span><span class="ruby-operator">:</span> [:<span class="ruby-identifier">cache</span>, :<span class="ruby-identifier">store</span>]</pre>
            
            <h2 id="module-Shrine::Plugins::DirectUpload-label-Authentication">Authentication<span><a href="#module-Shrine::Plugins::DirectUpload-label-Authentication">&para;</a> <a href="#top">&uarr;</a></span></h2>
            
            <p>If you want to authenticate the endpoint, you should be able to do it
            easily if your web framework has a good enough router. For example, in
            Rails you could add a <code>constraints</code> directive:</p>
            
            <pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>&#x000A;  <span class="ruby-identifier">constraints</span>(<span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span>(<span class="ruby-identifier">r</span>){<span class="ruby-identifier">r</span>.<span class="ruby-identifier">env</span>[<span class="ruby-string">&quot;warden&quot;</span>].<span class="ruby-identifier">authenticate!</span>}) <span class="ruby-keyword">do</span>&#x000A;    <span class="ruby-identifier">mount</span> <span class="ruby-constant">ImageUploader</span>.<span class="ruby-identifier">direct_endpoint</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;/attachments/images&quot;</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>Public Class</h3>
            <ol>
              <li><a target="docwin" href="#method-c-configure">configure</a></li>
              <li><a target="docwin" href="#method-c-load_dependencies">load_dependencies</a></li>
            </ol>
          </div>
          <div id='context'>
          </div>
          <div id='class-list'>
            <h2>Classes and Modules</h2>
            <ol>
              <li><a target="docwin" href="DirectUpload/ClassMethods.html">Shrine::Plugins::DirectUpload::ClassMethods</a></li>
              <li><a target="docwin" href="DirectUpload/App.html">Shrine::Plugins::DirectUpload::App</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='methods'>
              <h2>Public Class methods</h2>
              <div class='method public-class' id='method-method-c-configure'>
                <a name='method-c-configure'></a>
                <div class='synopsis'>
                  <span class='name'>configure</span>
                  <span class='arguments'>(uploader, allowed_storages: [:cache], max_size:, presign: nil)</span>
                </div>
                <div class='description'>
                  
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-c-configure-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-c-configure-source'><span class="ruby-comment"># File lib/shrine/plugins/direct_upload.rb, line 137</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">configure</span>(<span class="ruby-identifier">uploader</span>, <span class="ruby-identifier">allowed_storages</span><span class="ruby-operator">:</span> [<span class="ruby-value">:cache</span>], <span class="ruby-identifier">max_size</span>,, <span class="ruby-identifier">presign</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)&#x000A;  <span class="ruby-identifier">uploader</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:direct_upload_allowed_storages</span>] = <span class="ruby-identifier">allowed_storages</span>&#x000A;  <span class="ruby-identifier">uploader</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:direct_upload_max_size</span>] = <span class="ruby-identifier">max_size</span>&#x000A;  <span class="ruby-identifier">uploader</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:direct_upload_presign</span>] = <span class="ruby-identifier">presign</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-method-c-load_dependencies'>
                <a name='method-c-load_dependencies'></a>
                <div class='synopsis'>
                  <span class='name'>load_dependencies</span>
                  <span class='arguments'>(uploader, *)</span>
                </div>
                <div class='description'>
                  
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-c-load_dependencies-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-c-load_dependencies-source'><span class="ruby-comment"># File lib/shrine/plugins/direct_upload.rb, line 133</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">load_dependencies</span>(<span class="ruby-identifier">uploader</span>, <span class="ruby-operator">*</span>)&#x000A;  <span class="ruby-identifier">uploader</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:rack_file</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a target="docwin" href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
